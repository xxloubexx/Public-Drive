---
- name: Générer un certificat et configurer un site Web IIS sans modules supplémentaires
  hosts: PARDI01
  vars:
    site_name: Anthony
    site_port: 443
    site_ip: "*"
    site_path: C:\inetpub\anthony

  tasks:
    - name: Créer le certificat à partir du modèle
      win_shell: |
        $pfxFilePath = "C:\Users\Administrator.LYON2024\Documents\test.pfx"
        $pfxPassword = ConvertTo-SecureString -String "123" -AsPlainText -Force
        $certStoreLocation = "Cert:\LocalMachine\My"
        Import-PfxCertificate -FilePath $pfxFilePath -CertStoreLocation $certStoreLocation -Password $pfxPassword

    - name: Créer le site Web IIS avec le certificat généré
      win_shell: |
        Import-Module WebAdministration
        $certThumbprint = (Get-ChildItem -Path Cert:\LocalMachine\My | Where-Object { $_.Subject -eq "CN=anthony.lyon2024.local" }).Thumbprint
        #New-WebSite -Name "{{ site_name }}" -Port {{ site_port }} -IPAddress {{ site_ip }} -HostHeader "anthony.lyon2024.local" -PhysicalPath "{{ site_path }}" -Force
        New-WebSite -Name "{{ site_name }}"  -PhysicalPath "{{ site_path }}"  -Force
        New-WebBinding -Name "{{ site_name }}" -Protocol "https" -Port 443 -HostHeader "anthony.lyon2024.local"
        Remove-WebBinding -Name "{{ site_name }}" -Protocol "http" 
        $binding = Get-WebBinding -Name "{{ site_name }}" -Protocol "https"
        $binding.AddSslCertificate($certThumbprint, "My")
    - name: Vérifier que le site Web IIS est en cours d'exécution
      win_service:
        name: w3svc
        start_mode: auto
        state: started
        
